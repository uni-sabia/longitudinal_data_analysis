---
title: "Exercise 1"
author: "Uni Lee"
date: "2/16/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(haven)
library(desc)
library(survival)
library(dplyr)
```

# Data Preparation

```{r}
# Read in the data (European Social Survey 2018/19)
ess_raw <- read_dta("data/01_ESS/ESS9e03.dta", 
                encoding="latin1")

# Limit the investigation to the cohorts born 1920 to 1999
ess_full <- ess_raw %>% filter(yrbrn <= 1999 & yrbrn >=1920) %>%
  select(lvpntyr, yrbrn, cntry, inwyys, gndr) # select variables of interest

ess_no_na <- ess_full %>% 
  na.omit() # delete cases with missing data 

# Select country and gender 
ess_germany_women_all <- ess_no_na %>% 
  filter(cntry=="DE") %>% # Select Germany
  filter(gndr==2) # Select women

table(ess_germany_women_all$lvpntyr)

# Exclude the people who have never lived with a parent.

ess_germany_women <- ess_germany_women_all %>% filter(lvpntyr != 1111)
```

# Exercise 1.1

## a) Sample size

```{r}
nrow(ess_raw) # How large was the original sample? 
nrow(ess_raw) - nrow(ess_no_na) # How many rows whose values are missing?
nrow(ess_germany_women) # How large is the analytical sample?

```

The original sample had 49,519 observations. The analytical sample has 1074 observations. 
The sample size shrank because we eliminated rows with missing values for any of the variables of interest we selected, which adds up to 3855 observations. Finally, we zoomed in by selecting observations for women in Germany. Note that 2 observations were dropped because they had never lived with a parent (lvpntyr=1111).

## b) Construct an event history data (variables TIME and EVENT). How many events and
how many censored cases will enter your investigation? 

### Create an event variable

The following function creates an event variable that takes the value of 0 if the person has not left home yet, and 1 if the person has left home. 

```{r}

create_event <- function(x){ 
x <- x %>% mutate(event = 
                    case_when(lvpntyr==0 ~ 0,
                              lvpntyr>0 ~ 1)) %>%
  mutate(event = as.numeric(event))
x
}

ess_germany_women <- create_event(ess_germany_women)
table(ess_germany_women$event)

```

There are 1,020 events in our data set. There are 52 censored cases. 

### Create a time variable

The following function creates a time variable whose values are the age at which the person left home. For the censored cases, the time variable is the age at which the interview took place. 

```{r}
create_time <- function(x){
  x <- x %>% mutate(age1 = lvpntyr-yrbrn-1,
                    age2 = inwyys-yrbrn-1) %>%
    mutate(time = case_when(
      event==1 ~ age1,
      event==0 ~ age2)) %>%
    mutate(time=as.numeric(time))
}

ess_germany_women <- create_time(ess_germany_women)
```

# Exercise 1.2

## a) Estimate a survival function for your sample. 

```{r}
survival <- survfit(Surv(ess_germany_women$time, ess_germany_women$event) ~ 1)

plot(survival) # Step-function
summary(survival) # Overview of the table

```
The median age at which women in Germany leave home is 20 years old. This value is found where the Kaplan-meier estimate falls below 0.5 for the first time. 

At the age of 30, there are 37 people still living with their parents. 

The first event occured at the age of 6. 


## How do women's age of leaving home compare to men?

```{r}
ess_germany_men_all <- ess_no_na %>% 
  filter(cntry=="DE") %>% # Select Germany
  filter(gndr==1) # Select men

# Exclude the people who have never lived with a parent.
ess_germany_men <- ess_germany_men_all %>% filter(lvpntyr != 1111)

# Create event and time variables
ess_germany_men <- ess_germany_men %>% create_event() %>% create_time()

survival_men <- survfit(Surv(ess_germany_men$time, ess_germany_men$event) ~ 1)

plot(survival_men) # Step-function
summary(survival_men) # Overview of the table
```
The median age at which people leave home is also 20 years old for men in Germany.

## How do women in Germany compared to other countries? 

According to Isabel de Brigard from our class, the median age at which men leave home for France is 21. Women in Germany leave home earlier than men in France. 

# Exercise 1.3

## Event history data may be collected by retrospective as well as prospective surveys. ESS is a
retrospective survey. Do you think that your results are affected by this design? How does the
operationalization of the outcome variable affect the results? Discuss!

Since ESS is a retrospective survey, the data points depend on the study subject's memory. The results of the analysis may contain systemic errors that occur due to people's false memory. 

In this survey, the outcome variable is operationally defined as "the year at which people left home for 2 months or more". If this operational definition was not clearly explained during the survey or if respondents could not remember accurately, respondents may have reported the year in which they left home for less than 2 months. Especially in case of Europe where many people leave home at an early age to do an exchange semester abroad, the outcome variable will be much less than the actual age at which people became independent from their parents. 